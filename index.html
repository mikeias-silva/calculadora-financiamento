<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Financiamento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .readonly-field {
            background-color: #e9ecef !important;
            opacity: 1 !important;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-center">Calculadora Financiamento</h3>
                    </div>
                    <div class="card-body">
                        <form id="calculadoraForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="valorTotal" class="form-label">Valor Total</label>
                                    <input type="text" class="form-control money" id="valorTotal">
                                </div>
                                <div class="col-md-6">
                                    <label for="valorEntrada" class="form-label">Valor de Entrada</label>
                                    <input type="text" class="form-control money" id="valorEntrada">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="numMeses" class="form-label">Nº de meses</label>
                                    <input type="number" class="form-control" id="numMeses">
                                </div>
                                <div class="col-md-4">
                                    <label for="taxaJuros" class="form-label">Taxa de juros mensal (%)</label>
                                    <input type="number" class="form-control" id="taxaJuros" step="0.01">
                                </div>
                                <div class="col-md-4">
                                    <label for="taxaJurosAnual" class="form-label">Taxa de juros anual (%)</label>
                                    <input type="number" class="form-control readonly-field" id="taxaJurosAnual" step="0.01" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="valorPrestacao" class="form-label">Valor da prestação</label>
                                    <input type="text" class="form-control money" id="valorPrestacao">
                                </div>
                                <div class="col-md-6">
                                    <label for="valorFinanciado" class="form-label">Valor Financiado</label>
                                    <input type="text" class="form-control money readonly-field" id="valorFinanciado" readonly>
                                </div>
                            </div>
                            <hr>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="valorTotalFinanciamento" class="form-label">Total do Financiamento</label>
                                    <input type="text" class="form-control money readonly-field" id="valorTotalFinanciamento" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="valorTotalComEntrada" class="form-label">Total com Entrada</label>
                                    <input type="text" class="form-control money readonly-field" id="valorTotalComEntrada" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="valorTotalJuros" class="form-label">Total em Juros</label>
                                    <input type="text" class="form-control money readonly-field" id="valorTotalJuros" readonly>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="button" class="btn btn-primary" onclick="calcular()">Calcular</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/imask"></script>
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/imask"></script>
<script>
    // Aplica a máscara de dinheiro em todos os campos da classe .money
    document.querySelectorAll('.money').forEach(element => {
        IMask(element, {
            mask: 'R$ num',
            blocks: {
                num: {
                    mask: Number,
                    thousandsSeparator: '.',
                    radix: ',',
                    scale: 2,
                    padFractionalZeros: true,
                    normalizeZeros: true,
                    min: 0
                }
            }
        });
    });

    // Função para converter string de dinheiro (R$ 1.234,56) para número (1234.56)
    function parseMoney(value) {
        if (!value) return 0;
        return parseFloat(value.replace('R$ ', '').replace(/\./g, '').replace(',', '.'));
    }

    // Função para formatar um número para string de dinheiro
    function formatMoney(value) {
        return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    /**
     * Calcula a taxa de juros usando o Método da Bijeção.
     * @param {number} principal - O valor financiado.
     * @param {number} numPagamentos - O número de parcelas.
     * @param {number} valorParcela - O valor da parcela mensal.
     * @returns {number|null} A taxa de juros mensal como decimal, ou null se não for encontrada.
     */
    function calculateInterestRate(principal, numPagamentos, valorParcela) {
        let low = 0;
        let high = 1; // Supõe uma taxa máxima de 100% ao mês para o início da busca
        const tolerance = 0.000001;
        const maxIterations = 200;

        for (let i = 0; i < maxIterations; i++) {
            let mid = (low + high) / 2;
            if (mid < tolerance) { // Evita divisão por zero ou taxas muito pequenas
                return low > 0 ? low : 0;
            }
            
            // Fórmula da Tabela Price para calcular a parcela com base na taxa 'mid'
            let calculatedPayment = principal * mid / (1 - Math.pow(1 + mid, -numPagamentos));

            if (Math.abs(calculatedPayment - valorParcela) < tolerance) {
                return mid; // Taxa encontrada
            }

            // Ajusta os limites da busca
            if (calculatedPayment > valorParcela) {
                high = mid;
            } else {
                low = mid;
            }
        }
        return (low + high) / 2; // Retorna a melhor aproximação encontrada
    }

    function calcular() {
        // Obter valores dos campos de entrada
        const valorTotal = parseMoney(document.getElementById('valorTotal').value);
        const valorEntrada = parseMoney(document.getElementById('valorEntrada').value);
        const numMeses = parseInt(document.getElementById('numMeses').value) || 0;
        
        // Limpa os campos de input que serão calculados
        const taxaJurosInput = document.getElementById('taxaJuros');
        const valorPrestacaoInput = document.getElementById('valorPrestacao');
        
        // Calcula o valor a ser financiado
        const valorFinanciado = valorTotal - valorEntrada;
        document.getElementById('valorFinanciado').value = formatMoney(valorFinanciado);

        // --- VALIDAÇÕES BÁSICAS ---
        if (valorFinanciado <= 0 || numMeses <= 0) {
            alert('Por favor, preencha o Valor Total, a Entrada e o Nº de meses para continuar.');
            return;
        }

        let i; // Taxa de juros mensal em decimal
        let prestacaoFinal;

        // --- LÓGICA PRINCIPAL DE CÁLCULO ---

        // CENÁRIO 1: Calcular o VALOR DA PRESTAÇÃO com base na taxa de juros.
        if (taxaJurosInput.value && !valorPrestacaoInput.value) {
            const taxaJuros = parseFloat(taxaJurosInput.value.replace(',', '.'));
            if (isNaN(taxaJuros)) {
                alert("Taxa de juros inválida.");
                return;
            }
            i = taxaJuros / 100;
            
            // FÓRMULA CORRIGIDA (Tabela Price)
            // PMT = PV * [i / (1 - (1 + i)^-n)]
            if (i > 0) {
                prestacaoFinal = valorFinanciado * i / (1 - Math.pow(1 + i, -numMeses));
            } else { // Caso de juros zero
                prestacaoFinal = valorFinanciado / numMeses;
            }
            
            valorPrestacaoInput.value = formatMoney(prestacaoFinal);
        }
        // CENÁRIO 2: Calcular a TAXA DE JUROS com base no valor da prestação.
        else if (valorPrestacaoInput.value && !taxaJurosInput.value) {
            const valorPrestacao = parseMoney(valorPrestacaoInput.value);
            prestacaoFinal = valorPrestacao; // Usa a prestação informada para os cálculos totais
            
            // Verifica se o valor total das prestações cobre o valor financiado
            if (valorPrestacao * numMeses < valorFinanciado) {
                alert('O valor total pago (prestações x meses) é menor que o valor financiado. O empréstimo nunca seria quitado.');
                return;
            }
             // Caso especial: Juros Zero
            if (valorPrestacao * numMeses === valorFinanciado) {
                i = 0;
            } else {
                // Usa a função para encontrar a taxa
                i = calculateInterestRate(valorFinanciado, numMeses, valorPrestacao);
            }

            if (i !== null) {
                const taxaJuros = i * 100;
                taxaJurosInput.value = taxaJuros.toFixed(2).replace('.', ',');
            } else {
                alert('Não foi possível calcular uma taxa de juros para os valores informados.');
                return;
            }
        }
        // CENÁRIO 3: Informações insuficientes ou ambíguas
        else {
            alert('Preencha o "Nº de meses" e APENAS UM dos seguintes campos: "Taxa de juros mensal" ou "Valor da prestação".');
            return;
        }

        // --- CÁLCULO DOS TOTAIS ---

        // Calcula a taxa de juros anual efetiva
        const taxaJurosAnual = (Math.pow(1 + i, 12) - 1) * 100;
        document.getElementById('taxaJurosAnual').value = taxaJurosAnual.toFixed(2).replace('.', ',');
        
        // Calcula os totais do financiamento
        const valorTotalFinanciamento = prestacaoFinal * numMeses;
        const valorTotalComEntrada = valorTotalFinanciamento + valorEntrada;
        const valorTotalJuros = valorTotalFinanciamento - valorFinanciado;

        // Atualiza os campos de totais com valores formatados
        document.getElementById('valorTotalFinanciamento').value = formatMoney(valorTotalFinanciamento);
        document.getElementById('valorTotalComEntrada').value = formatMoney(valorTotalComEntrada);
        document.getElementById('valorTotalJuros').value = formatMoney(valorTotalJuros);
    }
</script>
</body>
</html>