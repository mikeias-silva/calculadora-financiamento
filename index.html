<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Financiamento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .readonly-field {
            background-color: #e9ecef !important;
            opacity: 1 !important;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-center">Calculadora Financiamento</h3>
                    </div>
                    <div class="card-body">
                        <form id="calculadoraForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="valorTotal" class="form-label">Valor Total</label>
                                    <input type="text" class="form-control money" id="valorTotal">
                                </div>
                                <div class="col-md-6">
                                    <label for="valorEntrada" class="form-label">Valor de Entrada</label>
                                    <input type="text" class="form-control money" id="valorEntrada">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="numMeses" class="form-label">Nº de meses</label>
                                    <input type="number" class="form-control" id="numMeses">
                                </div>
                                <div class="col-md-4">
                                    <label for="taxaJuros" class="form-label">Taxa de juros mensal (%)</label>
                                    <input type="number" class="form-control" id="taxaJuros" step="0.01">
                                </div>
                                <div class="col-md-4">
                                    <label for="taxaJurosAnual" class="form-label">Taxa de juros anual (%)</label>
                                    <input type="number" class="form-control readonly-field" id="taxaJurosAnual" step="0.01" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="valorPrestacao" class="form-label">Valor da prestação</label>
                                    <input type="text" class="form-control money" id="valorPrestacao">
                                </div>
                                <div class="col-md-6">
                                    <label for="valorFinanciado" class="form-label">Valor Financiado</label>
                                    <input type="text" class="form-control money readonly-field" id="valorFinanciado" readonly>
                                </div>
                            </div>
                            <hr>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="valorTotalFinanciamento" class="form-label">Total do Financiamento</label>
                                    <input type="text" class="form-control money readonly-field" id="valorTotalFinanciamento" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="valorTotalComEntrada" class="form-label">Total com Entrada</label>
                                    <input type="text" class="form-control money readonly-field" id="valorTotalComEntrada" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="valorTotalJuros" class="form-label">Total em Juros</label>
                                    <input type="text" class="form-control money readonly-field" id="valorTotalJuros" readonly>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="button" class="btn btn-primary" onclick="calcular()">Calcular</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <script>
        // Aplicar máscara em todos os campos de dinheiro
        document.querySelectorAll('.money').forEach(element => {
            IMask(element, {
                mask: 'R$ num',
                blocks: {
                    num: {
                        mask: Number,
                        thousandsSeparator: '.',
                        radix: ',',
                        scale: 2,
                        padFractionalZeros: true,
                        normalizeZeros: true,
                        min: 0
                    }
                }
            });
        });

        function parseMoney(value) {
            if (!value) return 0;
            return parseFloat(value.replace('R$ ', '').replace(/\./g, '').replace(',', '.'));
        }

        function formatMoney(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function calculateInterestRate(principal, numPayments, paymentAmount) {
            let low = 0;
            let high = 1; // 100% monthly
            let interestRate = 0.5;
            const tolerance = 0.000001;
            const maxIterations = 200;

            for (let i = 0; i < maxIterations; i++) {
                if (interestRate === 0) {
                    interestRate = 0.000001; // Avoid division by zero
                }
                
                let calculatedPayment = principal * interestRate / (1 - Math.pow(1 + interestRate, -numPayments));
                
                if (Math.abs(calculatedPayment - paymentAmount) < tolerance) {
                    return interestRate;
                }

                if (calculatedPayment > paymentAmount) {
                    high = interestRate;
                } else {
                    low = interestRate;
                }

                interestRate = (low + high) / 2;
            }

            return null; // Return null if no rate is found within tolerance and iterations
        }

        function calcular() {
            const valorTotal = parseMoney(document.getElementById('valorTotal').value);
            const valorEntrada = parseMoney(document.getElementById('valorEntrada').value);
            const numMeses = parseFloat(document.getElementById('numMeses').value) || 0;
            let taxaJuros = parseFloat(document.getElementById('taxaJuros').value) || 0;
            const valorPrestacaoInput = document.getElementById('valorPrestacao').value;
            let valorPrestacao = parseMoney(valorPrestacaoInput);

            const valorFinanciado = valorTotal - valorEntrada;
            document.getElementById('valorFinanciado').value = formatMoney(valorFinanciado);

            let i = taxaJuros / 100; // Monthly interest rate as decimal

            let prestacaoFinal = valorPrestacao;

            // Clear previous results
            document.getElementById('taxaJuros').value = '';
            document.getElementById('taxaJurosAnual').value = '';
            document.getElementById('valorPrestacao').value = '';
            document.getElementById('valorTotalFinanciamento').value = '';
            document.getElementById('valorTotalComEntrada').value = '';
            document.getElementById('valorTotalJuros').value = '';
            
            // --- CALCULATION LOGIC ---
            
            // Case 1: Calculate monthly payment (prestacao)
            if (valorFinanciado > 0 && numMeses > 0 && taxaJuros > 0) {
                // PMT = PV * (i * (1 + i)^n) / ((1 + i)^n - 1)
                prestacaoFinal = valorFinanciado * (i * Math.pow(1 + i, numMeses)) / (Math.pow(1 + i, numMeses) - 1);
                document.getElementById('valorPrestacao').value = formatMoney(prestacaoFinal);
            }
            // Case 2: Calculate interest rate (taxaJuros) when payment is known
            else if (valorFinanciado > 0 && numMeses > 0 && valorPrestacao > 0) {
                // Check if payment is too low to ever pay off the loan
                if (valorPrestacao < valorFinanciado / numMeses) {
                    alert('A prestação informada é muito baixa para o valor financiado e o número de meses. É impossível pagar o empréstimo com este valor.');
                    return;
                }
                
                i = calculateInterestRate(valorFinanciado, numMeses, valorPrestacao);
                
                if (i !== null) {
                    taxaJuros = i * 100;
                    document.getElementById('taxaJuros').value = taxaJuros.toFixed(2);
                    prestacaoFinal = valorPrestacao; // Use the provided prestacao for totals
                } else {
                    alert('Não foi possível encontrar uma taxa de juros mensal precisa para os valores informados.');
                    return; // Stop execution if no rate is found
                }
            }
            // Case 3: Calculate number of months (numMeses)
            else if (valorFinanciado > 0 && valorPrestacao > 0 && taxaJuros > 0) {
                if (valorPrestacao <= valorFinanciado * i) {
                    alert('A prestação é muito baixa para a taxa de juros e o valor financiado. O saldo nunca será quitado.');
                    return;
                }
                // n = log(PMT / (PMT - PV * i)) / log(1 + i)
                const meses = Math.log(valorPrestacao / (valorPrestacao - valorFinanciado * i)) / Math.log(1 + i);
                document.getElementById('numMeses').value = Math.round(meses);
                prestacaoFinal = valorPrestacao; // Use the provided prestacao for totals
            }
            else {
                alert('Por favor, preencha pelo menos 3 dos campos de financiamento (Valor Financiado, Nº de meses, Taxa de juros ou Valor da prestação) para calcular os dados restantes.');
                return; // Stop if not enough data
            }

            // --- CALCULATE TOTALS BASED ON FINAL VALUES ---
            
            const taxaJurosAnual = (Math.pow(1 + i, 12) - 1) * 100;
            document.getElementById('taxaJurosAnual').value = taxaJurosAnual.toFixed(2);
            
            const valorTotalFinanciamento = prestacaoFinal * numMeses;
            const valorTotalComEntrada = valorTotalFinanciamento + valorEntrada;
            const valorTotalJuros = valorTotalFinanciamento - valorFinanciado;

            // Update total fields
            document.getElementById('valorTotalFinanciamento').value = formatMoney(valorTotalFinanciamento);
            document.getElementById('valorTotalComEntrada').value = formatMoney(valorTotalComEntrada);
            document.getElementById('valorTotalJuros').value = formatMoney(valorTotalJuros);
        }
    </script>
</body>
</html>